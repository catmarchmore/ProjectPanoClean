@page
@using System.Text.Encodings.Web
@using System.Text.Json
@using ProjectPano
@using ProjectPano.Model
@using static ProjectPano.Model.DAL
@model ProjectPano.Pages.ETC.PMUI2Model
@{
    ViewData["FullWidth"] = true;
    ViewData["Title"] = "Estimates to Complete";
    var allEmpData = Model.ListEmpGroupResources?.Any() == true ? Model.ListEmpGroupResources : new List<vwEmpGroupResources>();
    var budgetData = Model.vwBudgetActuals?.Any() == true ? Model.vwBudgetActuals : new List<vwBudgetActuals_REVISED>();
}

<h5 class="custom-h1">Estimates to Complete</h5>


<div class="d-flex align-items-end" style="gap: 20px;">
    <label for="pmDropdown" class="mb-0 me-2">PM:</label>
    <select id="pmDropdown" class="selectpicker form-control w-auto" data-live-search="true" asp-items="Model.MgrSelectList"
            value="@Model.SelectedMgrName">
    </select>
</div>

<table class="table table-bordered table-sm">
    <thead>
        <tr>
            <th rowspan="2">Client and Job</th>
            <th colspan="4" class="text-center">PM</th>
            <th colspan="4" class="text-center">Engr</th>
            <th colspan="4" class="text-center">EIC</th>
            <th colspan="4" class="text-center">Design</th>
        </tr>
        <tr>
            @for (int i = 0; i < 4; i++)
            {
                <th>ETCHrs</th>
                <th>Start</th>
                <th>Finish</th>
@*                 <th>CurveID</th> *@
                <th>CurveName</th>
            }
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model.FilteredRows)
        {
            <tr>
                <td>@item.ClientJob</td>

                @foreach (var role in new[] { "PM", "Engr", "EIC", "Design" })
                {
                    var etchrs = Model.GetETCHrsForRole(item.JobID, role);
                    // For PlanStartWE, PlanFinishWE, CurveID, CurveName you can keep the OneLine properties (if they exist) or implement similar logic.

                    var start = (DateTime?)item.GetType().GetProperty($"PlanStartWE_{role}")?.GetValue(item);
                    var finish = (DateTime?)item.GetType().GetProperty($"PlanFinishWE_{role}")?.GetValue(item);
                    var curveId = (decimal?)item.GetType().GetProperty($"CurveID_{role}")?.GetValue(item);
                    var curveName = (string?)item.GetType().GetProperty($"CurveName_{role}")?.GetValue(item);

                    <td>
                        <a href="#" class="edit-etchrs" data-role="@role" data-jobid="@item.JobID">
                            @(etchrs.ToString("N1"))
                        </a>
                    </td>
                    <td>@(start?.ToString("MM/dd"))</td>
                    <td>@(finish?.ToString("MM/dd"))</td>
@*                     <td>@curveId</td> *@
                    <td>@curveName</td>
                }
            </tr>
        }

    </tbody>
</table>

<div id="addEtcContainer"></div>


<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <!-- use modal-xl or adjust size -->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="btn btn-sm btn-success ms-2" id="addNewBtn">+ New</button>
                <h5 class="modal-title" id="editModalLabel">Edit ETC Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="editModalContent">
                <!-- Partial Razor form will be loaded here -->
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>

    $(document).ready(function () {

        $('#pmDropdown').on('change', function () {
            const mgr = $(this).val();
            if (mgr) {
                // reload page with mgrName in query string
                window.location.href = `/ETC/PMUI2?mgrName=${encodeURIComponent(mgr)}`;
            } else {
                // optional: reload page without filter if no mgr selected
                window.location.href = `/ETC/PMUI2`;
            }
        });

        $('#editModal').modal('hide'); // hide modal just in case

        $('#addNewBtn').on('click', function () {
            const jobId = $('#JobID').val();
            const empResGroupDesc = $('#EmpResGroupDesc').val();
            console.log("jobId:", jobId, "empResGroupDesc:", empResGroupDesc);

            if (!jobId || !empResGroupDesc) {
                console.warn("Missing jobId or empResGroupDesc");
                return;
            }

            $('#editModalContent').load(`/ETC/PMUI2?handler=AddETCHrsPartial&jobId=${jobId}&empResGroupDesc=${encodeURIComponent(empResGroupDesc)}`, function () {
                console.log("✅ Add form loaded.");
                // Now manually show the modal inside the loaded partial
                $('#etcModal').modal('show');
            });
        });



        $('.edit-etchrs').on('click', function (e) {
            e.preventDefault();

            const jobId = $(this).data('jobid');
            const role = $(this).data('role');

            // Map role to EmpResGroupDesc string for filtering on the popup form
            const roleToGroup = {
                "PM": "PM",
                "Engr": "Engineering",
                "EIC": "EIC Engr & Design",
                "Design": "Mechanical Design"
            };
            const empResGroupDesc = roleToGroup[role];

            // Fetch the popup partial razor page filtered by jobId and empResGroupDesc
            $.get(`/Shared/Partials/EditETCHrs?jobId=${jobId}&empResGroupDesc=${encodeURIComponent(empResGroupDesc)}`, function (data) {
                $('#editModalContent').html(data);
                var modal = new bootstrap.Modal(document.getElementById('editModal'));
                modal.show();
            });

        });

    });


</script>
}
