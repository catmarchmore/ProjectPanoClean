@model ProjectPano.Model.AddETCPopupFormModel
@{
	Layout = null;
}

@* <div style="background-color: yellow; padding: 10px;">Partial Loaded ✅</div>
<strong style="color: green;">🚨 Add Form is rendered!</strong>

<div style="background-color: yellow; padding: 1rem;">
    Partial Loaded ✅
</div> *@

@* <input type="hidden" asp-for="DiscETC.JobID" /> *@


<!--form entry for vwDiscETC-->
<form id="addEtcForm" method="post" asp-page-handler="EditFormSingle" asp-antiforgery="true">
    <input asp-for="DiscETC.ETCHrs" class="form-control step="0.01" />

    <div id="etcModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="etcModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content p-4">
            <div class="modal-header">
                <h4 class="modal-title" id="etcModalLabel">Edit ETC Record</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

                <input type="hidden" asp-for="DiscETC.JobID" />
                <input type="hidden" id="discEtcId" asp-for="DiscETC.DiscEtcID" />
                <input type="hidden" id="rptWeekend" asp-for="DiscETC.RptWeekend" value="@Model.RptWE.ToString("yyyy-MM-dd")" />

                <div class="modal-body">
                    <div class="row">
                        <!-- Task Info -->
                        <div class="col-md-4">
                            <fieldset class="styled-fieldset">
                                <legend class="styled-legend-required">Task Info</legend>

                                <div class="form-group">
                                    <label for="obid">Task</label>
                                    <select class="form-control" id="obid" asp-for="DiscETC.OBID" required>
                                        <option value="">-- Select Task --</option>
                                        @foreach (var task in Model.vwBudgetActuals)
                                        {
                                            <option value="@task.OBID">@task.MYTASK</option>
                                        }
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="etccomment">ETC Comment</label>
                                    <textarea class="form-control" id="etccomment" asp-for="DiscETC.ETCComment"></textarea>
                                </div>
                            </fieldset>
                        </div>

                        <!-- Hrs/Cost -->
                        <div class="col-md-4">
                            <fieldset class="styled-fieldset">
                                <legend class="styled-legend-required">Hrs/Cost</legend>

                                <div class="form-group">
                                    <label for="empGroupId">Resource Group</label>
                                    <select class="form-control" id="empGroupId" asp-for="DiscETC.EmpGroupID" required>
                                        <option value="">-- Select Group --</option>
                                        @foreach (var group in Model.ListResourceGroups)
                                        {
                                            <option value="@group.EmpGroupID">@group.EmpGroup</option>
                                        }
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="empId">Employee (Optional)</label>
                                    <select class="form-control" id="empId" asp-for="DiscETC.EmpID">
                                        <option value="">-- Optional --</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="etchrs">ETC Hours</label>
                                    <input type="number" class="form-control text-right etchrs" id="etchrs" asp-for="DiscETC.ETCHrs" required step="0.01" />
                                </div>

                                <div class="form-group">
                                    <label for="rateSelect">ETC Rate Source</label>
                                    <select class="form-control" id="rateSelect">
                                        <option value="">-- Select Rate Type --</option>
                                        <option value="currrate">Current Rate</option>
                                        <option value="actrate">Actual Rate</option>
                                        <option value="other">Other (manual)</option>
                                    </select>
                                </div>

                                <div class="form-group" id="manualRateGroup">
                                    <label for="etcrate">ETC Rate <small>(<span id="rateDisplay">--</span>)</small></label>
                                    <input type="number" class="form-control text-right etcrate" id="etcrate" asp-for="DiscETC.ETCRate" required step="0.01" />
                                </div>

                                <div class="form-group">
                                    <label for="etccost">ETC Cost</label>
                                    <input type="number" class="form-control text-right etccost" id="etccost" asp-for="DiscETC.ETCCost" required step="0.01" />
                                </div>
                            </fieldset>
                        </div>

                        <!-- Schedule -->
                        <div class="col-md-4">
                            <fieldset class="styled-fieldset">
                                <legend class="styled-legend-required">Schedule</legend>

                                <div class="form-group">
                                    <label for="planstart">Planned Start Week Ending</label>
                                    <input type="date" class="form-control" id="planstart" asp-for="DiscETC.PlanStartWE" />
                                </div>

                                <div class="form-group">
                                    <label for="planfinish">Planned Finish Week Ending</label>
                                    <input type="date" class="form-control" id="planfinish" asp-for="DiscETC.PlanFinishWE" />
                                </div>

                                <div class="form-group">
                                    <label for="curveId">Curve Type</label>
                                    <select id="curveId" asp-for="DiscETC.CurveID" class="form-control">
                                        <option value="">-- Select Curve --</option>
                                        @foreach (var curve in Model.ListCurves)
                                        {
                                            <option value="@curve.CurveID">@curve.CurveName</option>
                                        }
                                    </select>
                                </div>
                            </fieldset>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Submit</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                </div>
        </div>
    </div>
</div>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
    $(document).ready(function () {

    $('#addEtcForm').on('submit', function (e) {
        e.preventDefault();

        const formData = $(this).serialize();

        // $.post('/ETC/PMUI2?handler=EditFormSingle', formData)
        $.post('/ETC/Index1?handler=AddSingleETC', formData)
            .done(function (response) {
                // Hide the Add modal
                $('#etcModal').modal('hide');

                // Optionally reload or refresh data on the main page
                location.reload();
            })
            .fail(function () {
                alert('Error saving new ETC record');
            });
    });

    //update etc cost
    $(document).on('input', '.etchrs, .etcrate', function () {
        console.log('Input changed');

        const hrs = parseFloat($('#etchrs').val()) || 0;
        const rate = parseFloat($('#etcrate').val()) || 0;

        const cost = (hrs * rate).toFixed(2);
        $('#etccost').val(cost);

        $('#etccost').toggleClass('zero-value', parseFloat(cost) === 0);
    });

    // $('.editRow').each(function() {
    //     const $row = $(this);
    //     $row.find('input, select').each(function() {
    //         const $input = $(this);
    //         $input.data('original-value', $input.val());
    //     });
    // });

    // $(document).on('click', '.cancel-edit-btn', function() {
    //     const $row = $(this).closest('tr');
    //     $row.find('input, select').each(function() {
    //         const $input = $(this);
    //         $input.val($input.data('original-value'));
    //     });
    // });

});

</script>
